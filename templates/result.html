<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Results ‚Äì Knowledge Synthesizer</title>

<style>
/* ---------- VARIABLES & RESET ---------- */
:root {
    --bg: #050814;
    --card-bg: rgba(255, 255, 255, 0.03);
    --card-border: rgba(255, 255, 255, 0.08);
    --text-main: #ffffff;
    --text-muted: #9ca3af;
    --accent: #a855f7;
    --accent-glow: rgba(168, 85, 247, 0.4);
    --nav-height: 70px; 
}

* {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
    font-family: "Inter", "Segoe UI", system-ui, sans-serif;
}

body {
    background-color: var(--bg);
    color: var(--text-main);
    height: 100vh;
    overflow: hidden;
    position: relative;
}

/* ---------- PARTICLES ---------- */
#particles-js {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 0;
    pointer-events: none;
}

/* ---------- LAYOUT STRUCTURE ---------- */
.page-wrapper {
    position: relative;
    z-index: 1;
    display: flex;
    height: 100vh;
    padding: 2rem;
    gap: 1.5rem;
}

/* ---------- SIDEBAR (DESKTOP) / NAVBAR (MOBILE) ---------- */
.sidebar {
    width: 70px;
    display: flex;
    flex-direction: column;
    gap: 1rem;
    z-index: 100;
}

.side-tab {
    writing-mode: vertical-rl;
    transform: rotate(180deg);
    background: rgba(255,255,255,0.05);
    border: 1px solid var(--card-border);
    border-radius: 14px;
    padding: 1.5rem 0.6rem;
    cursor: pointer;
    color: var(--text-muted);
    text-align: center;
    transition: all 0.3s ease;
    backdrop-filter: blur(10px);
}

.side-tab:hover, .side-tab.active {
    color: var(--text-main);
    border-color: var(--accent);
    background: rgba(168,85,247,0.1);
    box-shadow: 0 0 15px var(--accent-glow);
}

/* ---------- MAIN CONTENT ---------- */
.main {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
}

.cards {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 2rem;
    width: 100%;
    max-width: 1200px;
    height: 100%;
    align-content: center;
}

/* ---------- CARD STYLES ---------- */
.card {
    background: rgba(13, 17, 34, 0.6);
    border: 1px solid var(--card-border);
    border-radius: 24px;
    padding: 2rem;
    cursor: pointer;
    backdrop-filter: blur(12px);
    transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
    display: flex;
    flex-direction: column;
    position: relative;
    overflow: hidden;
    height: 600px; /* Fixed height for desktop */
}

/* Hover effect ONLY when not expanded */
.page-wrapper:not(.expanded) .card:hover {
    transform: translateY(-8px);
    border-color: rgba(255,255,255,0.2);
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
}

/* Expanded State (Desktop) */
.page-wrapper.expanded .cards {
    grid-template-columns: 1fr;
    height: 100%;
}

.page-wrapper.expanded .card {
    display: none;
}

.page-wrapper.expanded .card.active {
    display: flex;
    height: 100%;
    cursor: default;
    transform: none;
    box-shadow: 0 0 50px rgba(0,0,0,0.5);
    border-color: var(--accent);
}

.card-header {
    margin-bottom: 1rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.card h2 {
    font-size: 1.8rem;
    margin-bottom: 0.2rem;
    background: linear-gradient(to right, #fff, #c4b5fd);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
}

.card p {
    color: var(--text-muted);
}

.content {
    display: none;
    flex: 1;
    overflow-y: auto;
    margin-top: 0.5rem;
    padding-right: 5px;
}

.card.active .content {
    display: flex;
    flex-direction: column;
    animation: fadeIn 0.5s ease-out;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* ---------- CONTENT TEXT ---------- */
pre {
    white-space: pre-wrap;
    font-family: 'Inter', sans-serif;
    line-height: 1.8;
    font-size: 1.05rem;
    color: #e2e8f0;
}

/* ---------- MEMORY MAP UI ---------- */
.map-container {
    display: flex;
    flex-direction: column;
    height: 100%;
    gap: 1rem;
}

/* Map Wrapper */
.graph-wrapper {
    flex: 1;
    border-radius: 16px;
    border: 1px dashed var(--card-border);
    background: rgba(0,0,0,0.2);
    position: relative;
    overflow: hidden;
    min-height: 350px;
}

/* Map Controls */
.fullscreen-btn {
    position: absolute;
    top: 15px;
    right: 15px;
    background: rgba(0,0,0,0.6);
    border: 1px solid var(--card-border);
    color: white;
    width: 36px;
    height: 36px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    z-index: 10;
    transition: 0.2s;
    font-size: 1.2rem;
}

.map-nav {
    display: flex; 
    gap: 10px; 
    align-items: center;
}

.nav-arrow {
    background: rgba(255,255,255,0.1);
    border: 1px solid var(--card-border);
    color: white;
    width: 30px; 
    height: 30px;
    border-radius: 50%;
    cursor: pointer;
    display: flex; 
    align-items: center; 
    justify-content: center;
}
.nav-arrow:disabled { opacity: 0.3; cursor: default; }

/* Control Deck (Chat + Regen) */
.desktop-controls {
    display: flex;
    gap: 1.5rem;
    height: 250px;
}

.panel {
    flex: 1;
    background: rgba(255,255,255,0.03);
    border: 1px solid var(--card-border);
    border-radius: 16px;
    padding: 1rem;
    display: flex;
    flex-direction: column;
}

/* Chat Styles */
.chat-window {
    flex: 1;
    overflow-y: auto;
    margin-bottom: 0.8rem;
    display: flex;
    flex-direction: column;
    gap: 0.8rem;
}

.msg {
    padding: 8px 12px;
    border-radius: 12px;
    font-size: 0.9rem;
    line-height: 1.4;
    max-width: 90%;
}
.msg.ai { background: rgba(255,255,255,0.05); border-top-left-radius: 2px; align-self: flex-start; }
.msg.user { background: rgba(168,85,247,0.25); border-bottom-right-radius: 2px; align-self: flex-end; }

input, textarea {
    background: rgba(0,0,0,0.3);
    border: 1px solid var(--card-border);
    color: white;
    padding: 0.8rem;
    border-radius: 10px;
    outline: none;
    width: 100%;
}
input:focus, textarea:focus { border-color: var(--accent); }

.btn {
    background: var(--accent);
    color: white;
    border: none;
    padding: 0.8rem 1.2rem;
    border-radius: 10px;
    cursor: pointer;
    font-weight: 600;
    white-space: nowrap;
}

/* ---------- MOBILE RESPONSIVE FIXES ---------- */
@media (max-width: 768px) {
    body { height: 100vh; overflow: hidden; } 
    .page-wrapper { padding: 0; display: block; }
    
    /* 1. NAVBAR (1/8th Fixed Bottom) */
    .sidebar {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        height: var(--nav-height);
        flex-direction: row;
        justify-content: space-around;
        background: rgba(5, 8, 20, 0.95);
        backdrop-filter: blur(20px);
        border-top: 1px solid var(--card-border);
        padding: 0;
        z-index: 1000;
    }

    .side-tab {
        writing-mode: horizontal-tb;
        transform: none;
        background: transparent;
        border: none;
        border-radius: 0;
        padding: 5px;
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        font-size: 0.7rem;
        gap: 4px;
    }
    .side-tab.active { background: linear-gradient(to bottom, rgba(168,85,247,0.1), transparent); border-top: 2px solid var(--accent); }
    .tab-icon { font-size: 1.5rem; display: block; }

    /* 2. MAIN CONTAINER */
    .main {
        height: calc(100vh - var(--nav-height)); /* 7/8th of screen */
        padding: 0;
        align-items: flex-start;
        overflow: hidden;
    }

    .cards { display: block; height: 100%; }
    
    .card.active {
        height: 100%;
        border-radius: 0;
        border: none;
        background: transparent;
        padding: 0;
    }

    /* Text Sections */
    #notes.active, #details.active {
        overflow-y: auto;
        padding: 1.5rem;
    }

    /* 3. MAP LAYOUT (6/8 - 1/8 - 1/8) */
    #map.active .content {
        height: 100%;
        margin: 0;
        display: flex;
        flex-direction: column;
    }

    #map.active .map-container {
        height: 100%;
        gap: 0;
    }

    /* MAP SECTION (Prioritized Space) */
    .graph-wrapper {
        flex: 1; /* Takes all remaining space above controls */
        border-radius: 0 0 20px 20px;
        border-bottom: 1px solid var(--card-border);
        min-height: 0; /* Important for flex scaling */
    }
    
    .graph-wrapper.fullscreen {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: calc(100vh - var(--nav-height));
        z-index: 500;
        background: var(--bg);
        border-radius: 0;
    }

    /* 4. CONTROL DECK (PARALLEL & TALLER)
       Requested: "Horizontally parallel... at least 7 lines for chatbot"
    */
    .desktop-controls {
        height: 250px; /* Fixed height ~ 1/4th screen */
        flex-shrink: 0; /* Prevent shrinking */
        flex-direction: row; /* Side-by-Side */
        background: #050814;
        padding: 0.75rem;
        gap: 0.75rem;
        overflow: hidden;
    }

    /* Chat Panel (60% Width) */
    .panel.chat-panel-mobile {
        flex: 6; 
        background: rgba(255,255,255,0.03);
        border: 1px solid var(--card-border);
        padding: 0.5rem;
        border-radius: 12px;
        display: flex;
        flex-direction: column;
    }

    /* Regen Panel (40% Width) */
    .panel.regen-panel-mobile {
        flex: 4;
        background: rgba(255,255,255,0.03);
        border: 1px solid var(--card-border);
        padding: 0.5rem;
        border-radius: 12px;
        display: flex;
        flex-direction: column;
        justify-content: flex-end; /* Align bottom */
    }

    /* Chat Window inside Panel */
    .chat-window {
        flex: 1;
        height: 100%; /* Fill the panel */
        overflow-y: auto;
        margin-bottom: 5px;
        font-size: 0.8rem;
    }

    /* Adjust inputs for tight space */
    .panel input, .panel textarea {
        font-size: 0.8rem;
        padding: 6px;
    }
    .panel .btn {
        padding: 6px 10px;
        font-size: 0.8rem;
    }
    
    #map.active .card-header { display: none; }
}
</style>
</head>

<body>
    <div id="particles-js"></div>

    <div class="page-wrapper" id="layout">
        
        <div class="sidebar" id="sidebar">
            <div class="side-tab" onclick="expand('notes')">
                <span class="tab-icon">üìù</span>
                <span>Notes</span>
            </div>
            <div class="side-tab" onclick="expand('details')">
                <span class="tab-icon">üìò</span>
                <span>Details</span>
            </div>
            <div class="side-tab" onclick="expand('map')">
                <span class="tab-icon">üß†</span>
                <span>Map</span>
            </div>
        </div>

        <div class="main">
            <div class="cards">

                <div class="card" id="notes" onclick="expand('notes')">
                    <div class="card-header">
                        <h2>Key Notes</h2>
                    </div>
                    <div class="content">
                        <pre>{{ key_notes }}</pre>
                    </div>
                </div>

                <div class="card" id="details" onclick="expand('details')">
                    <div class="card-header">
                        <h2>Detailed Analysis</h2>
                    </div>
                    <div class="content">
                        <p>{{ detailed_points }}</p>
                    </div>
                </div>

                <div class="card" id="map" onclick="expand('map')">
                    <div class="card-header">
                        <h2>Memory Map</h2>
                        
                        <div class="map-nav" id="mapNav" style="display:none;" onclick="event.stopPropagation()">
                            <button class="nav-arrow" id="btnPrev" onclick="changeMap(-1)">‚Üê</button>
                            <span id="mapCounter" style="font-size:0.9rem; color:#d8b4fe;">Page 1/1</span>
                            <button class="nav-arrow" id="btnNext" onclick="changeMap(1)">‚Üí</button>
                        </div>
                    </div>

                    <div class="content" onclick="event.stopPropagation()">
                        <div class="map-container">
                            
                            <div class="graph-wrapper" id="graphContainer">
                                <div class="fullscreen-btn" onclick="toggleFullscreen()">‚õ∂</div>
                                <div id="graph" style="width:100%; height:100%;"></div>
                                
                                <div style="position:absolute; top:15px; left:15px; background:rgba(0,0,0,0.6); padding:4px 8px; border-radius:6px; font-size:0.75rem; pointer-events:none;">
                                    <span id="mapContextText" style="color:#d8b4fe;">Original Discussion</span>
                                </div>
                            </div>

                            <div class="desktop-controls" id="mobileControls">
                                
                                <div class="panel chat-panel-mobile">
                                    <div class="chat-window" id="chatMessages">
                                        <div class="msg ai">Ask me about the map!</div>
                                    </div>
                                    <div style="display:flex; gap:0.3rem;">
                                        <input type="text" id="chatInput" placeholder="Message..." onkeypress="if(event.key === 'Enter') sendChat()">
                                        <button class="btn" onclick="sendChat()">‚û§</button>
                                    </div>
                                </div>

                                <div class="panel regen-panel-mobile">
                                    <div style="flex:1;"></div> <span style="font-size:0.7rem; color:#9ca3af; margin-bottom:4px;">New Page Topic:</span>
                                    <textarea id="refineInput" rows="2" placeholder="e.g. Risks..." style="resize:none; margin-bottom:0.5rem; height:50px;"></textarea>
                                    <button class="btn" id="regenBtn" onclick="regenerateMap()" style="width:100%;">Create</button>
                                </div>

                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="/static/js/particles.min.js"></script>

    <script>
        // --- 1. PARTICLES & AUTO-OPEN LOGIC ---
        window.onload = function () {
            particlesJS("particles-js", {
                particles: {
                    number: { value: 80, density: { enable: true, value_area: 800 } },
                    color: { value: "#a855f7" },
                    opacity: { value: 0.5 },
                    size: { value: 3 },
                    line_linked: { enable: true, color: "#a855f7", opacity: 0.2 },
                    move: { enable: true, speed: 1 }
                }
            });
            
            // AUTO-OPEN: Skip the "3 Cards" screen completely
            {% if open_map %}
                setTimeout(() => expand('map'), 100);
            {% else %}
                setTimeout(() => expand('notes'), 100); // Default to notes
            {% endif %}
        };

        // --- 2. FULLSCREEN TOGGLE ---
        function toggleFullscreen() {
            const wrapper = document.getElementById('graphContainer');
            const controls = document.getElementById('mobileControls');
            const btn = document.querySelector('.fullscreen-btn');
            
            wrapper.classList.toggle('fullscreen');
            
            if(wrapper.classList.contains('fullscreen')) {
                // On mobile, hide controls to give full space
                if(window.innerWidth <= 768) controls.style.display = 'none';
                btn.innerText = "‚úñ";
                btn.style.background = "#ef4444";
            } else {
                controls.style.display = 'flex';
                btn.innerText = "‚õ∂";
                btn.style.background = "";
            }
            // Trigger D3 resize logic
            setTimeout(renderGraph, 100);
        }

        // --- 3. NAVIGATION & STATE ---
        const allMaps = {{ memory_maps | tojson }} || [];
        let currentMapIndex = allMaps.length > 0 ? allMaps.length - 1 : 0; 

        function expand(id) {
            const layout = document.getElementById("layout");
            const tabs = document.querySelectorAll(".side-tab");
            
            // UI Reset
            document.querySelectorAll(".card").forEach(c => c.classList.remove("active"));
            tabs.forEach(t => t.classList.remove("active"));
            
            // Activate
            document.getElementById(id).classList.add("active");
            layout.classList.add("expanded");
            
            // Highlight Tab
            const map = {'notes':0, 'details':1, 'map':2};
            if(tabs[map[id]]) tabs[map[id]].classList.add("active");

            // Safe Map Render
            if (id === "map") {
                updateMapUI();
                // RETRY LOGIC: Wait until container has width
                attemptRender();
            }
        }

        // --- 4. ROBUST RENDER RETRY ---
        function attemptRender() {
            const el = document.getElementById("graph");
            if(el.clientWidth > 0) {
                renderGraph();
            } else {
                // If hidden/zero width, retry quickly
                setTimeout(attemptRender, 50);
            }
        }

        function updateMapUI() {
            const nav = document.getElementById("mapNav");
            const counter = document.getElementById("mapCounter");
            const entry = allMaps[currentMapIndex];
            
            if(entry && entry.context) {
                let txt = entry.context;
                if(txt.length > 25) txt = txt.substring(0, 25) + "...";
                document.getElementById("mapContextText").innerText = txt;
            }

            if (allMaps.length > 1) {
                nav.style.display = "flex";
                counter.innerText = `Page ${currentMapIndex + 1}/${allMaps.length}`;
                document.getElementById("btnPrev").disabled = (currentMapIndex === 0);
                document.getElementById("btnNext").disabled = (currentMapIndex === allMaps.length - 1);
            } else {
                nav.style.display = "none";
            }
        }

        function changeMap(dir) {
            const newIndex = currentMapIndex + dir;
            if (newIndex >= 0 && newIndex < allMaps.length) {
                currentMapIndex = newIndex;
                updateMapUI();
                renderGraph();
            }
        }

        // --- 5. BACKEND CALLS ---
        async function sendChat() {
            const input = document.getElementById("chatInput");
            const msgs = document.getElementById("chatMessages");
            const text = input.value.trim();
            if(!text) return;
            
            msgs.innerHTML += `<div class="msg user">${text}</div>`;
            input.value = "";
            msgs.scrollTop = msgs.scrollHeight;

            try {
                const entry = allMaps[currentMapIndex];
                const mapData = entry ? entry.data : {};
                const res = await fetch("/chat", {
                    method: "POST", headers: {"Content-Type":"application/json"},
                    body: JSON.stringify({message:text, current_map:mapData})
                });
                const data = await res.json();
                msgs.innerHTML += `<div class="msg ai">${data.reply}</div>`;
                msgs.scrollTop = msgs.scrollHeight;
            } catch(e){ console.error(e); }
        }

        async function regenerateMap() {
            const input = document.getElementById("refineInput");
            const btn = document.getElementById("regenBtn");
            if(!input.value.trim()) return;
            btn.innerText = "..."; btn.disabled = true;
            try {
                const fd = new FormData(); fd.append("refinement_context", input.value);
                const res = await fetch("/result", {method:"POST", body:fd});
                if(res.ok) window.location.reload();
            } catch(e){ console.error(e); btn.disabled=false; }
        }

        // --- 6. D3 GRAPH RENDERER ---
        function renderGraph() {
            const entry = allMaps[currentMapIndex];
            const data = entry ? entry.data : {nodes:[], edges:[]};
            const el = document.getElementById("graph");
            
            // Ensure we have size
            const w = el.clientWidth;
            const h = el.clientHeight;
            if (w === 0 || h === 0) return; // Wait for retry loop

            el.innerHTML = "";
            
            if(!data.nodes || data.nodes.length === 0) {
                el.innerHTML = "<div style='display:flex;height:100%;align-items:center;justify-content:center;color:#666;'>No Data</div>";
                return;
            }

            const svg = d3.select("#graph").append("svg").attr("width", w).attr("height", h);
            const g = svg.append("g");
            
            const color = {concept:"#a855f7", argument:"#22c55e", concern:"#ef4444", outcome:"#3b82f6"};
            const ids = new Set(data.nodes.map(n=>n.id));
            const links = [];
            (data.edges||[]).forEach(e => {
                const s = e.from||e.source, t = e.to||e.target;
                if(ids.has(s) && ids.has(t)) links.push({source:s, target:t, relation:e.relation});
            });

            const sim = d3.forceSimulation(data.nodes)
                .force("link", d3.forceLink(links).id(d=>d.id).distance(100))
                .force("charge", d3.forceManyBody().strength(-200))
                .force("center", d3.forceCenter(w/2, h/2))
                .force("collide", d3.forceCollide().radius(25));

            const link = g.append("g").selectAll("line").data(links).enter().append("line")
                .attr("stroke", "#9ca3af").attr("stroke-width", 1.5)
                .attr("stroke-dasharray", d=>d.relation==="challenges"?"4,4":"0");

            const node = g.append("g").selectAll("circle").data(data.nodes).enter().append("circle")
                .attr("r", 15).attr("fill", d=>color[d.type]||"#999")
                .call(d3.drag().on("start", (e,d)=>{if(!e.active)sim.alphaTarget(0.3).restart();d.fx=d.x;d.fy=d.y})
                .on("drag", (e,d)=>{d.fx=e.x;d.fy=e.y})
                .on("end", (e,d)=>{if(!e.active)sim.alphaTarget(0);d.fx=null;d.fy=null}));

            const label = g.append("g").selectAll("text").data(data.nodes).enter().append("text")
                .attr("font-size", "10px").attr("fill", "#e5e7eb").attr("text-anchor", "middle").attr("dy", 25)
                .text(d=>d.label.length>12?d.label.substring(0,12)+"...":d.label);
            
            label.append("title").text(d=>d.label);

            sim.on("tick", () => {
                link.attr("x1",d=>d.source.x).attr("y1",d=>d.source.y).attr("x2",d=>d.target.x).attr("y2",d=>d.target.y);
                node.attr("cx",d=>d.x).attr("cy",d=>d.y);
                label.attr("x",d=>d.x).attr("y",d=>d.y);
            });
            
            svg.call(d3.zoom().scaleExtent([0.1,4]).on("zoom", e=>g.attr("transform", e.transform)));
        }
    </script>
</body>
</html>
